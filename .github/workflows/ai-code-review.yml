name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: AI Code Review
        env:
          # Required: API endpoint for the code review service
          API_ENDPOINT: ${{ secrets.AI_REVIEW_API_ENDPOINT }}
          # Optional: API key for the AI provider (if not provided, server-side keys will be used)
          # Recommended to set this if your API endpoint doesn't have server-side keys configured
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          # Optional: AI provider (defaults to 'openai' if not set)
          # Use 'vercel-ai-gateway' to use Vercel AI Gateway
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
          # Optional: Specific model to use (uses provider default if not set)
          AI_MODEL: ${{ secrets.AI_MODEL }}
          # Optional: Fallback models for Vercel AI Gateway (comma-separated list)
          # Example: "openai/gpt-4,anthropic/claude-3-opus"
          AI_FALLBACK_MODELS: ${{ secrets.AI_FALLBACK_MODELS }}
          # GITHUB_TOKEN is automatically provided by GitHub Actions - no need to set it as a secret
          # It's available as ${{ secrets.GITHUB_TOKEN }} or via the GITHUB_TOKEN environment variable
        run: |
          # Get PR information
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"

          # Set defaults if not provided
          AI_PROVIDER="${AI_PROVIDER:-openai}"

          echo "Reviewing PR: $PR_URL"
          echo "Using provider: $AI_PROVIDER"

          # Prepare request payload
          # Note: apiKey is optional - if not provided, the API will use server-side stored keys
          # For GitHub Actions, it's recommended to provide the API key via secrets
          # Build base payload
          BASE_PAYLOAD=$(cat <<EOF
          {
            "messages": [
              {
                "role": "user",
                "content": "Please review this pull request: $PR_URL"
              }
            ],
            "provider": "$AI_PROVIDER",
            "stream": false
          }
          EOF
          )
          
          # Add apiKey if provided
          if [ -n "$AI_API_KEY" ]; then
            BASE_PAYLOAD=$(echo "$BASE_PAYLOAD" | jq --arg key "$AI_API_KEY" '. + {"apiKey": $key}')
          fi
          
          # Add model if provided
          if [ -n "$AI_MODEL" ]; then
            BASE_PAYLOAD=$(echo "$BASE_PAYLOAD" | jq --arg model "$AI_MODEL" '. + {"model": $model}')
          fi
          
          # Add fallbackModels if provided (for Vercel AI Gateway)
          if [ -n "$AI_FALLBACK_MODELS" ]; then
            # Convert comma-separated string to JSON array
            FALLBACK_ARRAY=$(echo "$AI_FALLBACK_MODELS" | jq -R -s -c 'split(",") | map(select(length > 0) | gsub("^\\s+|\\s+$"; ""))')
            BASE_PAYLOAD=$(echo "$BASE_PAYLOAD" | jq --argjson fallbacks "$FALLBACK_ARRAY" '. + {"fallbackModels": $fallbacks}')
          fi
          
          # Add GitHub token and PR URL for automatic comment posting
          # GITHUB_TOKEN is automatically provided by GitHub Actions
          GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          if [ -n "$GITHUB_TOKEN" ]; then
            BASE_PAYLOAD=$(echo "$BASE_PAYLOAD" | jq --arg token "$GITHUB_TOKEN" '. + {"githubToken": $token}')
            BASE_PAYLOAD=$(echo "$BASE_PAYLOAD" | jq --arg url "$PR_URL" '. + {"prUrl": $url}')
          fi
          
          REQUEST_PAYLOAD="$BASE_PAYLOAD"

          # Call the AI code review API (non-streaming)
          echo "Calling API endpoint: $API_ENDPOINT"
          REVIEW_RESPONSE=$(curl -s -X POST "$API_ENDPOINT" \
            -H "Content-Type: application/json" \
            -d "$REQUEST_PAYLOAD")

          # Check if the API call was successful
          if echo "$REVIEW_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "Error from API: $(echo "$REVIEW_RESPONSE" | jq -r '.error')"
            exit 1
          fi

          # Extract the review text from the response
          # The API returns { text: "...", usage: {...} } for non-streaming
          REVIEW_TEXT=$(echo "$REVIEW_RESPONSE" | jq -r '.text // empty')

          if [ -z "$REVIEW_TEXT" ] || [ "$REVIEW_TEXT" = "null" ]; then
            echo "Error: No review content received"
            echo "Response: $REVIEW_RESPONSE"
            exit 1
          fi

          # If githubToken was provided, the API automatically posted the comment
          # Otherwise, we would need to post it manually here (but that's not needed anymore)
          if [ -n "$GITHUB_TOKEN" ]; then
            echo "Review completed! Comment should be automatically posted to PR #$PR_NUMBER"
          else
            echo "Review completed! (No GitHub token provided, comment not posted)"
          fi
