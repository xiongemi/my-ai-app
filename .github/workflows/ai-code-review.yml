name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: AI Code Review
        env:
          # Required: API endpoint for the code review service
          API_ENDPOINT: ${{ secrets.AI_REVIEW_API_ENDPOINT }}
          # Optional: API key for the AI provider (if not provided, server-side keys will be used)
          # Recommended to set this if your API endpoint doesn't have server-side keys configured
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          # Optional: AI provider (defaults to 'openai' if not set)
          # Use 'vercel-ai-gateway' to use Vercel AI Gateway
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
          # Optional: Specific model to use (uses provider default if not set)
          AI_MODEL: ${{ secrets.AI_MODEL }}
          # Optional: Fallback models for Vercel AI Gateway (comma-separated list)
          # Example: "openai/gpt-4,anthropic/claude-3-opus"
          AI_FALLBACK_MODELS: ${{ secrets.AI_FALLBACK_MODELS }}
          # Required: GitHub token for posting PR comments
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR information
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"

          # Set defaults if not provided
          AI_PROVIDER="${AI_PROVIDER:-openai}"

          echo "Reviewing PR: $PR_URL"
          echo "Using provider: $AI_PROVIDER"

          # Prepare request payload
          # Note: apiKey is optional - if not provided, the API will use server-side stored keys
          # For GitHub Actions, it's recommended to provide the API key via secrets
          # Build base payload
          BASE_PAYLOAD=$(cat <<EOF
          {
            "messages": [
              {
                "role": "user",
                "content": "Please review this pull request: $PR_URL"
              }
            ],
            "provider": "$AI_PROVIDER",
            "stream": false
          }
          EOF
          )
          
          # Add apiKey if provided
          if [ -n "$AI_API_KEY" ]; then
            BASE_PAYLOAD=$(echo "$BASE_PAYLOAD" | jq --arg key "$AI_API_KEY" '. + {"apiKey": $key}')
          fi
          
          # Add model if provided
          if [ -n "$AI_MODEL" ]; then
            BASE_PAYLOAD=$(echo "$BASE_PAYLOAD" | jq --arg model "$AI_MODEL" '. + {"model": $model}')
          fi
          
          # Add fallbackModels if provided (for Vercel AI Gateway)
          if [ -n "$AI_FALLBACK_MODELS" ]; then
            # Convert comma-separated string to JSON array
            FALLBACK_ARRAY=$(echo "$AI_FALLBACK_MODELS" | jq -R -s -c 'split(",") | map(select(length > 0) | gsub("^\\s+|\\s+$"; ""))')
            BASE_PAYLOAD=$(echo "$BASE_PAYLOAD" | jq --argjson fallbacks "$FALLBACK_ARRAY" '. + {"fallbackModels": $fallbacks}')
          fi
          
          REQUEST_PAYLOAD="$BASE_PAYLOAD"

          # Call the AI code review API (non-streaming)
          echo "Calling API endpoint: $API_ENDPOINT"
          REVIEW_RESPONSE=$(curl -s -X POST "$API_ENDPOINT" \
            -H "Content-Type: application/json" \
            -d "$REQUEST_PAYLOAD")

          # Extract the review text from the response
          # The API returns { text: "...", usage: {...} } for non-streaming
          REVIEW_TEXT=$(echo "$REVIEW_RESPONSE" | jq -r '.text // empty')

          if [ -z "$REVIEW_TEXT" ] || [ "$REVIEW_TEXT" = "null" ]; then
            echo "Error: No review content received"
            echo "Response: $REVIEW_RESPONSE"
            exit 1
          fi

          # Get usage info if available
          USAGE_INFO=""
          if echo "$REVIEW_RESPONSE" | jq -e '.usage' > /dev/null 2>&1; then
            PROMPT_TOKENS=$(echo "$REVIEW_RESPONSE" | jq -r '.usage.promptTokens // .usage.promptTokens // 0')
            COMPLETION_TOKENS=$(echo "$REVIEW_RESPONSE" | jq -r '.usage.completionTokens // .usage.completionTokens // 0')
            TOTAL_TOKENS=$(echo "$REVIEW_RESPONSE" | jq -r '.usage.totalTokens // .usage.totalTokens // 0')
            if [ "$TOTAL_TOKENS" != "0" ]; then
              USAGE_INFO="\n\n---\n**Usage:** $PROMPT_TOKENS prompt + $COMPLETION_TOKENS completion = $TOTAL_TOKENS tokens"
            fi
          fi

          # Post review as PR comment
          COMMENT_BODY=$(cat <<EOF
          ## ðŸ¤– AI Code Review

          $REVIEW_TEXT$USAGE_INFO
          EOF
          )

          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/comments" \
            -d "{\"body\": $(echo "$COMMENT_BODY" | jq -Rs .)}"

          echo "Review posted successfully!"
